<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Grillas de Himnos</title>
    <link rel="icon" type="images/emblema.png" href="images/emblema.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React y ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;
        
        // --- ICONOS INTEGRADOS (SVG) ---
        const Icon = ({ size = 24, className = "", children, ...props }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className} 
                {...props}
            >
                {children}
            </svg>
        );

        const Plus = (props) => <Icon {...props}><path d="M5 12h14"/><path d="M12 5v14"/></Icon>;
        const Trash2 = (props) => <Icon {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></Icon>;
        const Download = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></Icon>;
        const FileText = (props) => <Icon {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></Icon>;
        const Calendar = (props) => <Icon {...props}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></Icon>;
        const Star = (props) => <Icon {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></Icon>;
        const RotateCcw = (props) => <Icon {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></Icon>;

        // --- CONSTANTES ---
        const OPCIONES_HIMNARIOS = ['HI', 'HR', 'HC Vol. 1', 'HC Vol. 2', 'Otro'];
        const OPCIONES_ESTROFAS = [
            'Todas', '1°', '2°', '3°', '4°', '5°',
            '1° y 2°', '1° y 3°', '1° y 4°',
            '1°, 2° y 3°', '1°, 3° y 4°',
            '1°, 2°, 3° y 4°', '1°, 2°, 3°, 4° y 5°',
            'Solo Coro'
        ];
        const EVENTOS_ESPECIALES = [
            'Año Nuevo', 'Servicio Divino en Ayuda para los Difuntos', 'Domingo de Ramos', 'Viernes Santo', 'Pascua',
            'Ascensión', 'Pentecostés', 'Día internacional de Oración por la Paz', 'Día de Agradecimiento',
            'Día de Arrepentimiento y Oración', '1° Domingo de Adviento', '2° Domingo de Adviento', 
            '3° Domingo de Adviento', '4° Domingo de Adviento', 'Confirmación', 'Navidad', 
            'Último Servicio Divino del Año', 'Casamiento', 'Oficio por Transmisión'
        ];

        function App() {
            const [loading, setLoading] = useState(false);
            const printRef = useRef(null);

            const [fecha, setFecha] = useState('');
            const [tema, setTema] = useState('');
            const [esEventoEspecial, setEsEventoEspecial] = useState(false);
            const [nombreEvento, setNombreEvento] = useState(EVENTOS_ESPECIALES[0]);

            const initialHimnoState = { numero: '', himnario: 'HI', estrofas: 'Todas', titulo: '' };
            
            const [inicio, setInicio] = useState(initialHimnoState);
            const [texto, setTexto] = useState(initialHimnoState);
            const [cambio, setCambio] = useState(initialHimnoState);
            const [arrepentimiento, setArrepentimiento] = useState(initialHimnoState);
            const [cena, setCena] = useState(initialHimnoState);
            const [agradecimiento, setAgradecimiento] = useState(initialHimnoState);
            const [salida, setSalida] = useState(initialHimnoState);

            const [preoficio, setPreoficio] = useState([{ id: 1, ...initialHimnoState }]);
            const [descongregacion, setDescongregacion] = useState([{ id: 1, ...initialHimnoState }]);
            const [especiales, setEspeciales] = useState([]); 

            useEffect(() => {
                const hoy = new Date();
                const year = hoy.getFullYear();
                const month = String(hoy.getMonth() + 1).padStart(2, '0');
                const day = String(hoy.getDate()).padStart(2, '0');
                setFecha(`${year}-${month}-${day}`);
            }, []);

            const formatearFechaVisual = (fechaStr) => {
                if (!fechaStr) return 'Fecha no especificada';
                const [anio, mes, dia] = fechaStr.split('-');
                const fechaObj = new Date(anio, mes - 1, dia); 
                return fechaObj.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            };

            const agregarItem = (setFunc, lista) => setFunc([...lista, { id: Date.now(), ...initialHimnoState }]);
            const eliminarItem = (setFunc, lista, id) => setFunc(lista.filter(item => item.id !== id));
            
            const actualizarItemLista = (setFunc, lista, id, campo, valor) => {
                const nuevaLista = lista.map(item => item.id === id ? { ...item, [campo]: valor } : item);
                setFunc(nuevaLista);
            };

            const agregarEspecial = (tipo) => setEspeciales([...especiales, { id: Date.now(), tipo, ...initialHimnoState, detalleAporte: '' }]);
            
            const actualizarEspecial = (id, campo, valor) => {
                const nuevaLista = especiales.map(item => item.id === id ? { ...item, [campo]: valor } : item);
                setEspeciales(nuevaLista);
            };

            const resetearTodo = () => {
                if (window.confirm('¿Estás seguro de que deseas borrar toda la información y crear una nueva grilla?')) {
                    setFecha('');
                    setTema('');
                    setEsEventoEspecial(false);
                    setNombreEvento(EVENTOS_ESPECIALES[0]);
                    setInicio(initialHimnoState);
                    setTexto(initialHimnoState);
                    setCambio(initialHimnoState);
                    setArrepentimiento(initialHimnoState);
                    setCena(initialHimnoState);
                    setAgradecimiento(initialHimnoState);
                    setSalida(initialHimnoState);
                    setPreoficio([{ id: 1, ...initialHimnoState }]);
                    setDescongregacion([{ id: 1, ...initialHimnoState }]);
                    setEspeciales([]);
                    
                    // Restablecer fecha a hoy
                    const hoy = new Date();
                    const year = hoy.getFullYear();
                    const month = String(hoy.getMonth() + 1).padStart(2, '0');
                    const day = String(hoy.getDate()).padStart(2, '0');
                    setFecha(`${year}-${month}-${day}`);
                }
            };

            const descargarImagen = async () => {
                if (!window.html2canvas) return alert("Cargando librerías...");
                setLoading(true);
                
                await new Promise(resolve => setTimeout(resolve, 100));

                try {
                    const element = printRef.current;
                    // Dimensiones fijas para la imagen (500px de ancho)
                    const fixedWidth = 500;
                    
                    // Convertir todas las imágenes a base64 usando fetch para evitar problemas de CORS
                    const images = element.querySelectorAll('img');
                    const imagePromises = Array.from(images).map(async (img) => {
                        try {
                            // Si la imagen ya está en base64, no hacer nada
                            if (img.src.startsWith('data:')) {
                                return;
                            }
                            
                            // Usar fetch para cargar la imagen como blob y convertirla a base64
                            const response = await fetch(img.src);
                            if (!response.ok) {
                                console.warn('No se pudo cargar la imagen:', img.src);
                                return;
                            }
                            
                            const blob = await response.blob();
                            const reader = new FileReader();
                            
                            return new Promise((resolve) => {
                                reader.onloadend = () => {
                                    img.src = reader.result;
                                    resolve();
                                };
                                reader.onerror = () => {
                                    console.warn('Error al convertir imagen a base64:', img.src);
                                    resolve(); // Continuar aunque falle
                                };
                                reader.readAsDataURL(blob);
                            });
                        } catch (err) {
                            console.warn('Error al procesar imagen:', img.src, err);
                            // Continuar aunque falle
                        }
                    });
                    
                    // Esperar a que todas las imágenes se conviertan
                    await Promise.all(imagePromises);
                    await new Promise(resolve => setTimeout(resolve, 300)); // Tiempo extra para asegurar renderizado
                    
                    // Guardar estilos originales del elemento y su contenedor padre
                    const originalElementStyles = {
                        width: element.style.width,
                        minWidth: element.style.minWidth,
                        maxWidth: element.style.maxWidth,
                        boxSizing: element.style.boxSizing
                    };
                    
                    const parent = element.parentElement;
                    const originalParentStyles = {
                        width: parent.style.width,
                        maxWidth: parent.style.maxWidth,
                        overflow: parent.style.overflow
                    };
                    
                    // Forzar dimensiones fijas en el elemento y su contenedor
                    element.style.width = fixedWidth + 'px';
                    element.style.minWidth = fixedWidth + 'px';
                    element.style.maxWidth = fixedWidth + 'px';
                    element.style.boxSizing = 'border-box';
                    element.style.flexShrink = '0';
                    
                    parent.style.width = fixedWidth + 'px';
                    parent.style.maxWidth = fixedWidth + 'px';
                    parent.style.overflow = 'visible';
                    
                    // Esperar a que el navegador aplique los cambios
                    await new Promise(resolve => setTimeout(resolve, 150));
                    
                    // Obtener la altura real del contenido
                    const contentHeight = element.scrollHeight || element.offsetHeight;
                    
                    const canvas = await window.html2canvas(element, { 
                        scale: 2, 
                        backgroundColor: "#ffffff", 
                        useCORS: false,
                        allowTaint: true,
                        logging: false,
                        width: fixedWidth,
                        height: contentHeight,
                        windowWidth: fixedWidth,
                        windowHeight: contentHeight,
                        imageTimeout: 15000,
                        removeContainer: true,
                        foreignObjectRendering: false
                    });
                    
                    // Restaurar estilos originales
                    element.style.width = originalElementStyles.width;
                    element.style.minWidth = originalElementStyles.minWidth;
                    element.style.maxWidth = originalElementStyles.maxWidth;
                    element.style.boxSizing = originalElementStyles.boxSizing;
                    element.style.flexShrink = '';
                    
                    parent.style.width = originalParentStyles.width;
                    parent.style.maxWidth = originalParentStyles.maxWidth;
                    parent.style.overflow = originalParentStyles.overflow;
                    
                    // Usar toBlob en lugar de toDataURL para evitar el error de "tainted canvas"
                    canvas.toBlob((blob) => {
                        if (blob) {
                            const url = URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.download = `Grilla-${esEventoEspecial ? nombreEvento : 'Oficio'}-${fecha}.png`;
                            link.href = url;
                            link.click();
                            // Limpiar el objeto URL después de un momento
                            setTimeout(() => URL.revokeObjectURL(url), 100);
                        } else {
                            throw new Error('No se pudo generar el blob de la imagen');
                        }
                    }, 'image/png');
                } catch (err) {
                    console.error('Error detallado:', err);
                    alert(`Error al generar imagen: ${err.message || 'Error desconocido'}. Verifica la consola para más detalles.`);
                } finally {
                    setLoading(false);
                }
            };

            // Iconos
            const IconPlus = Plus;
            const IconTrash = Trash2;
            const IconDownload = Download;
            const IconFile = FileText;
            const IconCal = Calendar;
            const IconStar = Star;
            const IconReset = RotateCcw;

            return (
                <div className="min-h-screen bg-slate-100 font-sans text-slate-800 flex flex-col">
                {/* Navbar */}
                <nav className="bg-white shadow-md border-b border-slate-200">
                    <div className="max-w-7xl mx-auto px-4 py-4 flex items-center gap-3">
                        <img 
                            src="images/emblema.png" 
                            alt="Emblema" 
                            className="h-10 w-10 object-contain"
                            onError={(e) => {
                                e.target.style.display = 'none';
                            }}
                        />
                        <h1 className="text-2xl font-bold text-blue-700">Generador de Grillas de Himnos</h1>
                    </div>
                </nav>

                <div className="flex-1 p-4">
                <div className="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
                    
                    {/* --- FORMULARIO (7/12) --- */}
                    <div className="lg:col-span-7 space-y-6">
                    
                    {/* Datos del Oficio */}
                    <div className="bg-white p-6 rounded-xl shadow-md border border-slate-200">
                        <div className="flex justify-between items-start mb-4">
                            <h2 className="text-xl font-bold flex items-center text-blue-700">
                                <IconFile className="mr-2" size={20} /> Datos del Oficio
                            </h2>
                            <button 
                                onClick={resetearTodo} 
                                className="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold shadow flex items-center transition-all text-sm"
                                title="Borrar todo y crear nueva grilla"
                            >
                                <IconReset className="mr-2" size={18}/> Nueva Grilla
                            </button>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label className="block text-sm font-medium text-slate-600 mb-1">Fecha</label>
                            <input type="date" value={fecha} onChange={(e) => setFecha(e.target.value)} className="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none"/>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-600 mb-1">Tema / Título</label>
                            <input type="text" placeholder="Ej: La Fe que Vence" value={tema} onChange={(e) => setTema(e.target.value)} className="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none"/>
                        </div>
                        </div>

                        {/* Selector de Evento Especial */}
                        <div className="mt-4 pt-4 border-t border-slate-100">
                        <label className="flex items-center space-x-2 cursor-pointer mb-3">
                            <input type="checkbox" checked={esEventoEspecial} onChange={(e) => setEsEventoEspecial(e.target.checked)} className="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 border-gray-300"/>
                            <span className={`font-semibold ${esEventoEspecial ? 'text-blue-700' : 'text-slate-600'}`}>¿Es un Evento Especial?</span>
                        </label>

                        {esEventoEspecial && (
                            <div className="animate-in fade-in slide-in-from-top-2 duration-300 bg-blue-50 p-3 rounded-lg border border-blue-100">
                            <label className="block text-xs font-bold text-blue-800 uppercase tracking-wide mb-1">Seleccionar Evento</label>
                            <select value={nombreEvento} onChange={(e) => setNombreEvento(e.target.value)} className="w-full p-2 border border-blue-200 rounded text-sm bg-white outline-none focus:ring-2 focus:ring-blue-500">
                                {EVENTOS_ESPECIALES.map(evt => <option key={evt} value={evt}>{evt}</option>)}
                            </select>
                            </div>
                        )}
                        </div>
                    </div>

                    {/* Estructura Musical */}
                    <div className="bg-white p-6 rounded-xl shadow-md border border-slate-200">
                        <h2 className="text-lg font-bold mb-6 text-slate-700 border-b pb-2">Estructura Musical</h2>

                        <ListaDinamiaca titulo="Preoficio" items={preoficio} setItems={setPreoficio} agregarItem={agregarItem} eliminarItem={eliminarItem} actualizarItemLista={actualizarItemLista} placeholderTitulo="Título del himno" IconPlus={IconPlus} IconTrash={IconTrash} />

                        <div className="space-y-4 mb-8 mt-6 bg-slate-50 p-4 rounded-lg border border-slate-200">
                        <h3 className="font-semibold text-slate-700 mb-2">Himnos Centrales</h3>
                        <InputHimnoCompleto label="Inicio" himnoData={inicio} setHimnoData={setInicio} />
                        <InputHimnoCompleto label="Texto Bíblico" himnoData={texto} setHimnoData={setTexto} />
                        <InputHimnoCompleto label="Cambio Siervo" himnoData={cambio} setHimnoData={setCambio} />
                        <InputHimnoCompleto label="Arrepentimiento" himnoData={arrepentimiento} setHimnoData={setArrepentimiento} />
                        <InputHimnoCompleto label="Santa Cena" himnoData={cena} setHimnoData={setCena} />
                        <InputHimnoCompleto label="Agradecimiento" himnoData={agradecimiento} setHimnoData={setAgradecimiento} />
                        <InputHimnoCompleto label="Salida" himnoData={salida} setHimnoData={setSalida} />
                        </div>

                        <ListaDinamiaca titulo="Descongregación" items={descongregacion} setItems={setDescongregacion} agregarItem={agregarItem} eliminarItem={eliminarItem} actualizarItemLista={actualizarItemLista} placeholderTitulo="Título del himno" IconPlus={IconPlus} IconTrash={IconTrash} />

                        {/* Sección Especial */}
                        <div className="mt-8 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                            <div className="flex justify-between items-center mb-4">
                            <span className="text-sm font-bold text-yellow-800 uppercase tracking-wide">Bloque Especial / Aportes</span>
                            <div className="flex gap-2">
                                <button onClick={() => agregarEspecial('himno')} className="text-xs bg-white border border-yellow-300 text-yellow-700 px-3 py-1 rounded shadow-sm hover:bg-yellow-100 font-medium flex items-center gap-1"><IconPlus size={12}/> Himno Extra</button>
                                <button onClick={() => agregarEspecial('aporte')} className="text-xs bg-white border border-yellow-300 text-yellow-700 px-3 py-1 rounded shadow-sm hover:bg-yellow-100 font-medium flex items-center gap-1"><IconPlus size={12}/> Aporte Musical</button>
                            </div>
                            </div>
                            <div className="space-y-2">
                            {especiales.map((item) => (
                                <div key={item.id} className="flex flex-col sm:flex-row gap-2 items-start sm:items-center bg-white p-2 rounded border border-yellow-100">
                                <span className={`text-xs px-2 py-1 rounded font-bold w-20 text-center ${item.tipo === 'himno' ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}`}>
                                    {item.tipo === 'himno' ? 'Himno' : 'Aporte'}
                                </span>
                                
                                {item.tipo === 'himno' ? (
                                    <div className="flex-1 grid grid-cols-1 sm:grid-cols-12 gap-2 w-full">
                                    <div className="sm:col-span-2"><input placeholder="N°" value={item.numero} onChange={(e) => actualizarEspecial(item.id, 'numero', e.target.value)} className="w-full p-2 border border-slate-300 rounded text-sm outline-none focus:border-blue-500" /></div>
                                    <div className="sm:col-span-3"><SelectorBasic valor={item.himnario} onChange={(v) => actualizarEspecial(item.id, 'himnario', v)} opciones={OPCIONES_HIMNARIOS} /></div>
                                    <div className="sm:col-span-3"><SelectorBasic valor={item.estrofas} onChange={(v) => actualizarEspecial(item.id, 'estrofas', v)} opciones={OPCIONES_ESTROFAS} /></div>
                                    <div className="sm:col-span-4"><input placeholder="Título" value={item.titulo} onChange={(e) => actualizarEspecial(item.id, 'titulo', e.target.value)} className="w-full p-2 border border-slate-300 rounded text-sm outline-none focus:border-blue-500" /></div>
                                    </div>
                                ) : (
                                    <input placeholder="Detalle del aporte..." value={item.detalleAporte} onChange={(e) => actualizarEspecial(item.id, 'detalleAporte', e.target.value)} className="flex-1 p-2 border border-slate-300 rounded text-sm outline-none focus:border-blue-500 w-full" />
                                )}
                                <button onClick={() => eliminarItem(setEspeciales, especiales, item.id)} className="text-red-400 hover:text-red-600 p-1"><IconTrash size={18} /></button>
                                </div>
                            ))}
                            {especiales.length === 0 && <p className="text-sm text-slate-500 italic text-center py-2">No hay elementos especiales agregados.</p>}
                            </div>
                        </div>
                    </div>
                    </div>

                    {/* --- VISTA PREVIA (5/12) --- */}
                    <div className="lg:col-span-5 flex flex-col items-center">
                    <div className="sticky top-6 w-full flex flex-col items-center space-y-4">
                        
                        <div className="w-full flex justify-between items-center bg-blue-50 p-4 rounded-lg border border-blue-100 shadow-sm">
                        <div><h3 className="font-bold text-blue-800">Vista Previa</h3></div>
                        <button onClick={descargarImagen} disabled={loading} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold shadow flex items-center transition-all disabled:opacity-50">
                            {loading ? 'Generando...' : <><IconDownload className="mr-2" size={20}/> Descargar</>}
                        </button>
                        </div>

                        {/* CANVAS */}
                        <div className="w-full overflow-auto flex justify-center bg-gray-200 p-4 rounded-xl shadow-inner border border-gray-300">
                        <div ref={printRef} className="bg-white shadow-xl relative flex flex-col" style={{ fontFamily: "'Inter', sans-serif", width: '500px', minHeight: '600px' }}>
                            
                            {/* Header Dinámico */}
                            <div className="text-white p-5 border-b-4 border-yellow-500 relative overflow-hidden" style={{ backgroundColor: '#4A90E2', textAlign: 'center', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center' }}>
                            <div className="absolute inset-0 opacity-10 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-white via-transparent to-transparent"></div>

                            {/* Título Principal */}
                            <h1 className="text-xl font-extrabold uppercase tracking-[0.15em] relative z-10 mb-2" style={{ textAlign: 'center', margin: '0 0 8px 0', width: '100%' }}>Himnos para el Oficio</h1>
                            
                            {/* Tema */}
                            {tema && (
                                <div className="relative z-10" style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', width: '100%', marginTop: '8px', marginBottom: '8px' }}>
                                    <h2 className="text-lg font-semibold italic relative z-10 border-b pb-1 px-4" style={{ color: '#E8F4F8', borderColor: '#5B9BD5', textAlign: 'center', display: 'inline-block' }}>
                                        "{tema}"
                                    </h2>
                                </div>
                            )}

                            {/* Evento Especial */}
                            {esEventoEspecial && nombreEvento && (
                                <div className="relative z-10" style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', width: '100%', marginTop: '12px' }}>
                                <span className="px-3 py-1 rounded-full bg-yellow-500/20 border border-yellow-500/50 text-yellow-300 text-xs font-bold uppercase tracking-widest shadow-sm backdrop-blur-sm" style={{ display: 'inline-flex', alignItems: 'center', justifyContent: 'center', gap: '4px' }}>
                                    <IconStar size={10} className="fill-yellow-300" style={{ flexShrink: 0, display: 'block' }} /> <span style={{ display: 'inline-block' }}>{nombreEvento}</span>
                                </span>
                                </div>
                            )}

                            <div className="relative z-10" style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', width: '100%', marginTop: '12px', gap: '4px' }}>
                                <IconCal size={12} style={{ flexShrink: 0, display: 'block' }} />
                                <span className="text-xs font-medium uppercase tracking-wider" style={{ color: '#E8F4F8', display: 'inline-block' }}>{formatearFechaVisual(fecha)}</span>
                            </div>
                            </div>

                            {/* Cuerpo */}
                            <div className="flex-1 bg-white p-4">
                            <div className="border border-slate-200 rounded-lg overflow-hidden shadow-sm">
                                {preoficio.some(h => h.titulo) && <SectionGroup title="Preoficio" items={preoficio} color="bg-slate-50" />}

                                <div className="divide-y divide-slate-100">
                                <Row label="Inicio" himno={inicio} />
                                <Row label="Texto" himno={texto} />
                                <Row label="Cambio de Siervo" himno={cambio} />
                                <Row label="Arrepentimiento" himno={arrepentimiento} />
                                {cena.titulo && <Row label="Santa Cena" himno={cena} />}
                                <Row label="Agradecimiento" himno={agradecimiento} />
                                <Row label="Salida" himno={salida} />
                                </div>

                                {descongregacion.some(h => h.titulo) && <SectionGroup title="Descongregación" items={descongregacion} color="bg-slate-50" />}
                            </div>
                            </div>

                            {/* Especiales */}
                            {especiales.some(e => e.tipo === 'himno' ? e.titulo : e.detalleAporte) && (
                            <div className="px-4 pb-4 bg-white relative z-10">
                                <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 shadow-sm">
                                <h4 className="text-center text-xs font-bold text-yellow-800 uppercase tracking-widest border-b border-yellow-200 pb-2 mb-2">
                                    Bloque Especial y Aportes
                                </h4>
                                <div className="space-y-2">
                                    {especiales.map((esp) => {
                                    if (esp.tipo === 'himno' && esp.titulo) {
                                        return (
                                        <div key={esp.id} className="flex text-sm items-start justify-center" style={{ textAlign: 'center' }}>
                                            <span className="text-slate-700 font-medium">
                                            {esp.numero ? `${esp.numero} ` : ''} 
                                            {esp.himnario} ({esp.estrofas}) - "{esp.titulo}"
                                            </span>
                                        </div>
                                        );
                                    } else if (esp.tipo === 'aporte' && esp.detalleAporte) {
                                        return (
                                        <div key={esp.id} className="flex text-sm items-start justify-center" style={{ textAlign: 'center' }}>
                                            <span className="font-bold text-green-800 mr-2">Aporte:</span>
                                            <span className="text-slate-700 font-medium italic">{esp.detalleAporte}</span>
                                        </div>
                                        );
                                    }
                                    return null;
                                    })}
                                </div>
                                </div>
                            </div>
                            )}

                            <div className="p-3 text-center text-[9px] text-slate-400 border-t bg-slate-50 uppercase tracking-widest">
                            ¡Bendecido Trabajo!
                            </div>
                        </div>
                        </div>

                    </div>
                    </div>
                </div>
                </div>

                {/* Footer */}
                <footer className="bg-white border-t border-slate-200 mt-8">
                    <div className="max-w-7xl mx-auto px-4 py-4 text-center text-sm text-slate-600">
                        <p className="flex items-center justify-center gap-2 flex-wrap">
                            <span>® Creado por</span>
                            <a 
                                href="https://www.linkedin.com/in/josé-alberto-rodríguez1998" 
                                target="_blank" 
                                rel="noopener noreferrer"
                                className="text-blue-600 hover:text-blue-800 underline font-semibold"
                            >
                                José Alberto Rodríguez
                            </a>
                            <span>- 2025</span>
                            <span className="text-slate-400">|</span>
                            <span className="text-slate-500 font-medium">Versión 1.0.0</span>
                        </p>
                    </div>
                </footer>
                </div>
            );
        }

        // --- SUBCOMPONENTES ---

        function SelectorBasic({ valor, onChange, opciones }) {
            return (
                <select value={valor} onChange={(e) => onChange(e.target.value)} className="w-full p-2 border border-slate-300 rounded text-sm outline-none focus:border-blue-500 bg-white">
                {opciones.map(op => <option key={op} value={op}>{op}</option>)}
                </select>
            );
        }

        function InputHimnoCompleto({ label, himnoData, setHimnoData }) {
            const updateField = (field, value) => setHimnoData(prev => ({ ...prev, [field]: value }));
            return (
                <div className="flex flex-col sm:flex-row sm:items-center gap-2 py-1">
                <label className="sm:w-32 text-sm font-bold text-slate-600 shrink-0">{label}</label>
                <div className="flex-1 grid grid-cols-1 sm:grid-cols-12 gap-2 w-full">
                    <div className="sm:col-span-2"><input value={himnoData.numero} onChange={(e) => updateField('numero', e.target.value)} className="w-full p-2 border border-slate-300 rounded text-sm focus:border-blue-500 outline-none" placeholder="N°" /></div>
                    <div className="sm:col-span-3"><SelectorBasic valor={himnoData.himnario} onChange={(v) => updateField('himnario', v)} opciones={OPCIONES_HIMNARIOS} /></div>
                    <div className="sm:col-span-3"><SelectorBasic valor={himnoData.estrofas} onChange={(v) => updateField('estrofas', v)} opciones={OPCIONES_ESTROFAS} /></div>
                    <input value={himnoData.titulo} onChange={(e) => updateField('titulo', e.target.value)} className="sm:col-span-4 p-2 border border-slate-300 rounded text-sm focus:border-blue-500 outline-none" placeholder="Título" />
                </div>
                </div>
            );
        }

        function ListaDinamiaca({ titulo, items, setItems, agregarItem, eliminarItem, actualizarItemLista, placeholderTitulo, IconPlus, IconTrash }) {
            return (
                <div className="mb-6">
                <div className="flex justify-between items-center mb-3">
                    <label className="font-semibold text-slate-700">{titulo}</label>
                    <button onClick={() => agregarItem(setItems, items)} className="text-xs bg-blue-50 text-blue-700 px-3 py-1 rounded-full border border-blue-200 hover:bg-blue-100 flex items-center font-medium transition-colors"><IconPlus size={14} className="mr-1"/> Agregar Himno</button>
                </div>
                <div className="space-y-3">
                {items.map((item, index) => (
                    <div key={item.id} className="flex flex-col sm:flex-row gap-2 items-start sm:items-center bg-slate-50 p-2 rounded border border-slate-200">
                    <span className="text-xs font-bold text-slate-400 w-6 text-center shrink-0">#{index + 1}</span>
                    <div className="flex-1 grid grid-cols-1 sm:grid-cols-12 gap-2 w-full">
                        <div className="sm:col-span-2"><input placeholder="N°" value={item.numero} onChange={(e) => actualizarItemLista(setItems, items, item.id, 'numero', e.target.value)} className="w-full p-2 border border-slate-300 rounded text-sm outline-none focus:border-blue-500" /></div>
                        <div className="sm:col-span-3"><SelectorBasic valor={item.himnario} onChange={(v) => actualizarItemLista(setItems, items, item.id, 'himnario', v)} opciones={OPCIONES_HIMNARIOS} /></div>
                        <div className="sm:col-span-3"><SelectorBasic valor={item.estrofas} onChange={(v) => actualizarItemLista(setItems, items, item.id, 'estrofas', v)} opciones={OPCIONES_ESTROFAS} /></div>
                        <div className="sm:col-span-4"><input placeholder={placeholderTitulo} value={item.titulo} onChange={(e) => actualizarItemLista(setItems, items, item.id, 'titulo', e.target.value)} className="w-full p-2 border border-slate-300 rounded text-sm outline-none focus:border-blue-500" /></div>
                    </div>
                    {items.length > 0 && <button onClick={() => eliminarItem(setItems, items, item.id)} className="text-red-400 hover:text-red-600 p-1 sm:ml-1"><IconTrash size={18} /></button>}
                    </div>
                ))}
                </div>
                </div>
            );
        }

        function Row({ label, himno }) {
            if (!himno.titulo) return null;
            return (
                <div className="flex border-b border-slate-100 last:border-0">
                <div className="w-[110px] px-1 py-3 text-[10px] font-bold border-r border-slate-100 flex items-center justify-center uppercase tracking-tight text-slate-600 leading-tight text-center break-words">
                    {label}
                </div>
                <div className="flex-1 p-3 flex items-center" style={{ textAlign: 'left' }}>
                    <span className="text-[14px] text-slate-800 font-medium leading-normal">
                    {himno.numero ? `${himno.numero} ` : ''} 
                    {himno.himnario} ({himno.estrofas}) - "{himno.titulo}"
                    </span>
                </div>
                </div>
            );
        }

        function SectionGroup({ title, items, color }) {
            const activeItems = items.filter(i => i.titulo);
            if (activeItems.length === 0) return null;
            return (
                <div className={`border-b border-slate-200 ${color}`}>
                <div className="px-3 py-2 text-[11px] font-extrabold text-slate-500 uppercase tracking-widest border-b border-slate-100 bg-slate-100/50">{title}</div>
                {activeItems.map((item, idx) => (
                    <div key={item.id} className="flex border-b border-slate-100 last:border-0">
                    <div className="w-[50px] p-2 text-xs font-bold text-slate-400 border-r border-slate-100 flex items-center justify-center bg-slate-50/50 shrink-0">{idx + 1}</div>
                    <div className="flex-1 p-2 flex items-center" style={{ textAlign: 'left' }}>
                        <span className="text-[14px] text-slate-700 font-medium leading-normal">
                            {item.numero ? `${item.numero} ` : ''}
                            {item.himnario} ({item.estrofas}) - "{item.titulo}"
                        </span>
                    </div>
                    </div>
                ))}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>